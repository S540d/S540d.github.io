name: Security Monitor - Scan all gh-pages branches

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  scan-repositories:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        repo:
          - 1x1_Trainer
          - Energy_Price_Germany
          - Eisenhauer
          # Add more repos here as needed

    steps:
      - name: Checkout ${{ matrix.repo }} gh-pages
        uses: actions/checkout@v4
        with:
          repository: S540d/${{ matrix.repo }}
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for git history scan
        continue-on-error: true

      - name: Scan for sensitive files
        id: scan
        run: |
          echo "Scanning ${{ matrix.repo }} for sensitive files..."

          # List of sensitive files/directories to check
          SENSITIVE_PATTERNS=(
            "node_modules/"
            "credentials.json"
            ".env"
            ".env.local"
            ".env.production"
            ".env.staging"
            ".env.testing"
            "*.jks"
            ".vscode/"
            ".husky/"
            "coverage/"
            ".expo/"
            ".templates/"
            ".venv/"
            "Keystore/"
            "Android_old/"
            "Playstore_apps/"
          )

          FOUND_FILES=""
          ISSUE_NEEDED=false

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            # Check if files/directories exist
            if ls -d $pattern 2>/dev/null | grep -q .; then
              echo "‚ö†Ô∏è FOUND: $pattern"
              FOUND_FILES="$FOUND_FILES\n- $pattern"
              ISSUE_NEEDED=true
            fi
          done

          if [ "$ISSUE_NEEDED" = true ]; then
            echo "issue_needed=true" >> $GITHUB_OUTPUT
            echo "found_files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FOUND_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "‚ùå Sensitive files found in ${{ matrix.repo }}!"
          else
            echo "issue_needed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No sensitive files found in ${{ matrix.repo }}"
          fi

      - name: Check file sizes (>10MB warning)
        id: filesize
        run: |
          echo "Checking for large files (>10MB)..."

          LARGE_FILES=$(find . -type f -size +10M 2>/dev/null | grep -v ".git/" || true)

          if [ -n "$LARGE_FILES" ]; then
            echo "‚ö†Ô∏è Large files found:"
            echo "$LARGE_FILES"
            echo "large_files<<EOF" >> $GITHUB_OUTPUT
            echo "$LARGE_FILES" | while read file; do
              size=$(du -h "$file" | cut -f1)
              echo "- $file ($size)"
            done >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_large_files=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No large files found"
            echo "has_large_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Scan Git history for sensitive files
        id: history
        run: |
          echo "Scanning Git history for deleted sensitive files..."

          SENSITIVE_IN_HISTORY=$(git log --all --pretty=format: --name-only --diff-filter=D | \
            grep -E '(credentials\.json|\.env|\.jks|node_modules/)' | \
            sort -u | head -20 || true)

          if [ -n "$SENSITIVE_IN_HISTORY" ]; then
            echo "‚ö†Ô∏è Sensitive files found in Git history (deleted but still in commits):"
            echo "$SENSITIVE_IN_HISTORY"
            echo "history_files<<EOF" >> $GITHUB_OUTPUT
            echo "$SENSITIVE_IN_HISTORY" | while read file; do
              echo "- $file"
            done >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_history_files=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No sensitive files in Git history"
            echo "has_history_files=false" >> $GITHUB_OUTPUT
          fi

      - name: Check HTTPS/SSL configuration
        id: https
        run: |
          echo "Checking HTTPS/SSL configuration..."

          REPO_URL="https://s540d.github.io/${{ matrix.repo }}/"

          # Check if HTTPS is accessible
          if curl -s -o /dev/null -w "%{http_code}" "$REPO_URL" | grep -q "200"; then
            echo "‚úÖ HTTPS is accessible: $REPO_URL"
            echo "https_ok=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è HTTPS check failed for $REPO_URL"
            echo "https_ok=false" >> $GITHUB_OUTPUT
          fi

          # Check SSL certificate
          if echo | openssl s_client -connect s540d.github.io:443 -servername s540d.github.io 2>/dev/null | \
             openssl x509 -noout -dates | grep -q "notAfter"; then
            EXPIRY=$(echo | openssl s_client -connect s540d.github.io:443 -servername s540d.github.io 2>/dev/null | \
                     openssl x509 -noout -dates | grep "notAfter" | cut -d= -f2)
            echo "‚úÖ SSL certificate valid until: $EXPIRY"
            echo "ssl_expiry=$EXPIRY" >> $GITHUB_OUTPUT
          fi

      - name: Scan for external scripts/CDN links
        id: external
        run: |
          echo "Scanning HTML files for external scripts..."

          EXTERNAL_SCRIPTS=$(find . -name "*.html" -type f 2>/dev/null | \
            xargs grep -h -E '<script[^>]*src=' 2>/dev/null | \
            grep -v "s540d.github.io" | \
            grep -E 'http[s]?://' | \
            sed 's/.*src="\([^"]*\)".*/\1/' | \
            sort -u | head -20 || true)

          if [ -n "$EXTERNAL_SCRIPTS" ]; then
            echo "üìã External scripts found:"
            echo "$EXTERNAL_SCRIPTS"
            echo "external_scripts<<EOF" >> $GITHUB_OUTPUT
            echo "$EXTERNAL_SCRIPTS" | while read script; do
              echo "- $script"
            done >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_external_scripts=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No external scripts found"
            echo "has_external_scripts=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine if issue is needed
        id: final
        run: |
          ISSUE_NEEDED=false

          if [ "${{ steps.scan.outputs.issue_needed }}" == "true" ]; then
            ISSUE_NEEDED=true
          fi

          if [ "${{ steps.filesize.outputs.has_large_files }}" == "true" ]; then
            ISSUE_NEEDED=true
          fi

          if [ "${{ steps.history.outputs.has_history_files }}" == "true" ]; then
            ISSUE_NEEDED=true
          fi

          if [ "${{ steps.https.outputs.https_ok }}" == "false" ]; then
            ISSUE_NEEDED=true
          fi

          echo "issue_needed=$ISSUE_NEEDED" >> $GITHUB_OUTPUT

          if [ "$ISSUE_NEEDED" == "true" ]; then
            echo "‚ùå Security issues detected!"
            exit 1
          else
            echo "‚úÖ All checks passed!"
          fi

      - name: Create Issue if problems found
        if: failure() && steps.final.outputs.issue_needed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const repo = '${{ matrix.repo }}';

            let issueBody = `## üîí Security Scan Results\n\n**Repository:** ${repo}\n**Branch:** gh-pages\n**Scan Date:** ${new Date().toISOString()}\n\n`;

            // Sensitive files
            if ('${{ steps.scan.outputs.issue_needed }}' === 'true') {
              issueBody += `### ‚ö†Ô∏è Sensitive Files Found\n\n$\{{ steps.scan.outputs.found_files }}\n\n`;
              issueBody += `**Action:** Remove these files from gh-pages branch\n\n`;
            }

            // Large files
            if ('${{ steps.filesize.outputs.has_large_files }}' === 'true') {
              issueBody += `### üì¶ Large Files (>10MB)\n\n$\{{ steps.filesize.outputs.large_files }}\n\n`;
              issueBody += `**Action:** Consider removing or optimizing large files\n\n`;
            }

            // Git history
            if ('${{ steps.history.outputs.has_history_files }}' === 'true') {
              issueBody += `### üìú Sensitive Files in Git History\n\n$\{{ steps.history.outputs.history_files }}\n\n`;
              issueBody += `**Warning:** These files were deleted but still exist in Git history. Consider using \`git filter-branch\` or BFG Repo-Cleaner to remove them permanently.\n\n`;
            }

            // HTTPS check
            if ('${{ steps.https.outputs.https_ok }}' === 'false') {
              issueBody += `### üîê HTTPS Issue\n\n`;
              issueBody += `HTTPS is not accessible for this repository. Check GitHub Pages settings.\n\n`;
            }

            // External scripts (informational)
            if ('${{ steps.external.outputs.has_external_scripts }}' === 'true') {
              issueBody += `### üåê External Scripts Detected (Informational)\n\n$\{{ steps.external.outputs.external_scripts }}\n\n`;
              issueBody += `**Note:** External scripts are not necessarily a security risk, but review them to ensure they're from trusted sources.\n\n`;
            }

            issueBody += `### üõ†Ô∏è Quick Fix\n\n\`\`\`bash\ncd /path/to/${repo}\ngit checkout gh-pages\n./scripts/cleanup-gh-pages.sh\ngit push origin gh-pages\n\`\`\`\n\n`;
            issueBody += `---\nü§ñ Auto-generated by Security Monitor`;

            const issueTitle = `üö® Security Scan Issues: ${repo}`;

            // Check if similar issue already exists (open)
            const issues = await github.rest.issues.listForRepo({
              owner: 'S540d',
              repo: 'S540d.github.io',
              state: 'open',
              labels: ['security', 'gh-pages']
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(repo) && issue.title.includes('Sensitive files')
            );

            if (!existingIssue) {
              // Create new issue
              await github.rest.issues.create({
                owner: 'S540d',
                repo: 'S540d.github.io',
                title: issueTitle,
                body: issueBody,
                labels: ['security', 'gh-pages', 'automated']
              });
              console.log(`‚úÖ Created security issue for ${repo}`);
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: 'S540d',
                repo: 'S540d.github.io',
                issue_number: existingIssue.number,
                body: `üîÑ **Update:** Sensitive files still present as of ${new Date().toISOString()}\n\n${foundFiles}`
              });
              console.log(`‚úÖ Updated existing security issue #${existingIssue.number} for ${repo}`);
            }

  summary:
    runs-on: ubuntu-latest
    needs: scan-repositories
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## üîí Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.scan-repositories.result }}" == "success" ]; then
            echo "‚úÖ **All repositories are clean!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No sensitive files found on any gh-pages branch." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Security issues detected!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the job logs and created issues for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scanned Repositories:" >> $GITHUB_STEP_SUMMARY
          echo "- 1x1_Trainer" >> $GITHUB_STEP_SUMMARY
          echo "- Energy_Price_Germany" >> $GITHUB_STEP_SUMMARY
          echo "- Eisenhauer" >> $GITHUB_STEP_SUMMARY
